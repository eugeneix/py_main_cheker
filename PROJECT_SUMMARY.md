# Сводка проекта: Веб-монитор с уведомлениями в Telegram

## Что было создано

Полностью рабочее Python-приложение для мониторинга веб-страниц с автоматической отправкой уведомлений в Telegram при изменении или исчезновении элементов на странице.

## Основная задача

Приложение проверяет каждую минуту наличие определенного элемента на веб-странице (например, "Рождество 2026" на сайте rtoperator.ru) и отправляет уведомления в Telegram:
- ✅ Если элемент найден - отправляет "OK" уведомление каждую минуту
- ⚠️ Если элемент изменился - отправляет предупреждение
- ⚠️ Если элемент исчез - отправляет предупреждение

## Технические детали

### Технологии:
- **Python 3.10+**
- **Selenium** с ChromeDriver для работы с браузером
- **python-telegram-bot 20.7+** для отправки уведомлений в Telegram
- **Работает на VPS Ubuntu/Debian без Docker**

### Ключевые особенности:

1. **Жесткое обновление страницы каждую минуту:**
   - Полная очистка cookies перед каждой проверкой
   - Очистка localStorage, sessionStorage, кэша
   - Принудительное обновление страницы без кэша (добавление timestamp к URL)
   - Ожидание полной загрузки страницы
   - Гарантирует получение свежих данных с сервера, а не из кэша

2. **Поддержка различных селекторов:**
   - CSS селекторы (`#id`, `.class`, `div.element`)
   - XPath (`//div[@id='status']`)
   - Автоматический поиск по тексту (`auto`)

3. **Интеграция с Telegram:**
   - Поддержка личных чатов (Chat ID: положительное число)
   - Поддержка групп и каналов (Chat ID: отрицательное число)
   - Поддержка username каналов (`@channel_name`)
   - Асинхронная работа с Telegram API

4. **Устойчивость:**
   - Автоматический перезапуск WebDriver при ошибках
   - Обработка временной недоступности элементов
   - Подробное логирование в файл и консоль
   - Автоматический перезапуск при критических ошибках

5. **Кроссплатформенность:**
   - Работает на Linux (VPS)
   - Работает на Windows (для тестирования)
   - Автоматическое определение ОС и настройка параметров

## Структура проекта

```
py_main_cheker/
├── web_monitor.py              # Основной скрипт мониторинга
├── requirements.txt            # Python зависимости
├── install.sh                  # Скрипт установки для VPS
├── web-monitor.service         # Systemd сервис для автозапуска
├── config.example.py          # Пример конфигурации
├── config.rtoperator.py        # Конфигурация для rtoperator.ru
├── test_windows.bat            # Скрипт запуска на Windows
├── test_windows.ps1            # Скрипт запуска на Windows (PowerShell)
├── README.md                   # Основная документация
├── QUICKSTART.md               # Быстрый старт
├── ШАГИ_ЗАПУСКА.md            # Пошаговая инструкция
├── INSTRUCTION_RTOPERATOR.md   # Инструкция для rtoperator.ru
├── TELEGRAM_GROUP_CHANNEL.md # Работа с группами/каналами
├── GET_CHAT_ID.md             # Как получить Chat ID
├── TEST_WINDOWS.md            # Тестирование на Windows
└── .gitignore                 # Исключения для Git
```

## Как работает

### Процесс мониторинга:

1. **Инициализация:**
   - Подключение к Telegram боту
   - Создание Chrome WebDriver с отключенным кэшем
   - Настройка параметров браузера

2. **Цикл проверки (каждую минуту):**
   ```
   ┌─────────────────────────────────────┐
   │ 1. Очистка cookies                  │
   │ 2. Очистка localStorage/sessionStorage│
   │ 3. Загрузка страницы с timestamp    │
   │ 4. Принудительное обновление        │
   │ 5. Ожидание полной загрузки         │
   │ 6. Поиск элемента на странице       │
   │ 7. Сравнение с предыдущим значением │
   │ 8. Отправка уведомления (если нужно)│
   └─────────────────────────────────────┘
   ```

3. **Обработка результатов:**
   - Элемент найден → `[OK] Элемент на месте!` + уведомление в Telegram
   - Элемент изменился → `[WARNING] Элемент изменился!` + уведомление
   - Элемент исчез → `[WARNING] Элемент отсутствует!` + уведомление

## Пример использования

### Для мониторинга "Рождество 2026" на rtoperator.ru:

```bash
python web_monitor.py \
  "https://www.rtoperator.ru/" \
  "ТОКЕН_БОТА" \
  "@channel_name" \
  "auto" \
  "Рождество 2026"
```

### Параметры:
1. **URL** - адрес страницы для мониторинга
2. **Telegram Token** - токен бота от @BotFather
3. **Chat ID** - ID чата/группы/канала или username канала
4. **Селектор** - `auto` для автопоиска или конкретный селектор
5. **Ожидаемый текст** - текст элемента, который должен быть на странице

## Настройка Telegram

### Создание бота:
1. Откройте [@BotFather](https://t.me/BotFather)
2. Отправьте `/newbot`
3. Следуйте инструкциям
4. Сохраните токен

### Получение Chat ID:

**Для личного чата:**
- Используйте [@userinfobot](https://t.me/userinfobot)
- Отправьте `/start`
- Скопируйте ваш ID (положительное число)

**Для группы/канала:**
- Добавьте бота в группу/канал
- Сделайте бота администратором (для каналов обязательно)
- Используйте [@RawDataBot](https://t.me/RawDataBot) для получения Chat ID
- Или используйте username канала: `@channel_name`

## Установка на VPS

### Быстрая установка:
```bash
# 1. Установка зависимостей
sudo bash install.sh

# 2. Установка Python библиотек
pip3 install -r requirements.txt

# 3. Запуск
python3 web_monitor.py "URL" "TOKEN" "CHAT_ID" "auto" "Текст"
```

### Автозапуск через systemd:
```bash
# 1. Отредактируйте web-monitor.service
sudo nano /etc/systemd/system/web-monitor.service

# 2. Активируйте сервис
sudo systemctl daemon-reload
sudo systemctl enable web-monitor.service
sudo systemctl start web-monitor.service
```

## Особенности реализации

### Очистка кэша:
- Отключение кэша в настройках Chrome
- Удаление cookies перед каждой проверкой
- Очистка всех хранилищ браузера
- Добавление timestamp к URL для обхода кэша
- Принудительное обновление страницы

### Асинхронная работа с Telegram:
- Использование `asyncio` для работы с python-telegram-bot 20+
- Правильная обработка event loop
- Поддержка как Chat ID, так и username каналов

### Обработка ошибок:
- Автоматический перезапуск WebDriver при ошибках
- Пропуск проверки при временной недоступности элемента
- Логирование всех ошибок
- Продолжение работы при некритических ошибках

## Формат уведомлений

### Уведомление "OK":
```
✅ Элемент на месте!

Время: 2025-11-08 00:45 (МСК)
Текст: Рождество 2026
Всё в порядке.
```

### Уведомление об изменении:
```
⚠️ Элемент изменился!

Время: 2025-11-08 00:45 (МСК)
Ожидался: Рождество 2026
Найден: Ноябрьские праздники
```

### Уведомление об отсутствии:
```
⚠️ Элемент отсутствует!

Время: 2025-11-08 00:45 (МСК)
Ожидался элемент с текстом: Рождество 2026
Элемент не найден на странице
```

## Текущая конфигурация

- **URL:** https://www.rtoperator.ru/
- **Элемент:** "Рождество 2026"
- **Селектор:** `auto` (автоматический поиск по тексту)
- **Telegram канал:** @lelelelasd
- **Интервал проверки:** 60 секунд
- **Интервал "OK" уведомлений:** 60 секунд

## Команды для запуска

### Windows (тест):
```powershell
$env:HEADLESS = "false"
python web_monitor.py "https://www.rtoperator.ru/" "8208055846:AAFNFYKN4mPfvO4aPQ13xOr4aqGw_ayuyCA" "@lelelelasd" "auto" "Рождество 2026"
```

### Linux (VPS):
```bash
python3 web_monitor.py "https://www.rtoperator.ru/" "8208055846:AAFNFYKN4mPfvO4aPQ13xOr4aqGw_ayuyCA" "@lelelelasd" "auto" "Рождество 2026
```

## Что проверяется

Приложение каждую минуту:
1. Полностью очищает кэш и cookies браузера
2. Загружает свежую версию страницы с сервера
3. Ищет элемент с текстом "Рождество 2026"
4. Сравнивает результат с предыдущей проверкой
5. Отправляет уведомление в Telegram при изменениях

## Результат

Полностью автоматизированный мониторинг веб-страницы с мгновенными уведомлениями в Telegram при любых изменениях. Приложение работает непрерывно, автоматически перезапускается при ошибках и не требует ручного вмешательства.

